
{
  "entities": {
    "PatientMaster": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PatientMaster",
      "type": "object",
      "description": "Represents a patient's master record with demographic information.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the patient master record." },
        "name": { "type": "string", "description": "Patient's full name." },
        "age": { "type": "number", "description": "Patient's age." },
        "gender": { "type": "string", "enum": ["male", "female", "other"], "description": "Patient's gender." },
        "contactNumber": { "type": "string", "description": "Patient's contact phone number." },
        "emailAddress": { "type": "string", "format": "email", "description": "Patient's email address." }
      },
      "required": ["id", "name", "age", "gender", "contactNumber"]
    },
    "PatientTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PatientTransaction",
      "type": "object",
      "description": "Represents a single transactional visit for a patient.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the patient transaction." },
        "contactNumber": { "type": "string", "description": "Patient's contact phone number, used to link to the patient master record." },
        "clinicId": { "type": "string", "description": "The ID of the clinic for this transaction." },
        "groupId": { "type": "string", "description": "The ID of the group for this transaction." },
        "cabinId": { "type": "string", "description": "The ID of the cabin assigned for consultation." },
        "tokenNumber": { "type": "string", "description": "The token number for this visit." },
        "status": { "type": "string", "enum": ["waiting", "calling", "consulting", "no-show", "consultation-done"], "description": "The current status of the patient in the queue." },
        "registeredAt": { "type": "string", "format": "date-time", "description": "Timestamp when the token was generated." },
        "consultingStartTime": { "type": "string", "format": "date-time", "description": "Timestamp when the consultation started." },
        "consultingEndTime": { "type": "string", "format": "date-time", "description": "Timestamp when the consultation ended." }
      },
      "required": ["id", "contactNumber", "clinicId", "groupId", "tokenNumber", "status", "registeredAt"]
    },
    "Consultation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Consultation",
      "type": "object",
      "description": "Represents a consultation between a doctor and a patient.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Consultation entity."
        },
        "doctorId": {
          "type": "string",
          "description": "Reference to Doctor. (Relationship: Doctor 1:N Consultation)"
        },
        "startTime": {
          "type": "string",
          "description": "Date and time when the consultation started.",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "Date and time when the consultation ended. Nullable if the consultation is ongoing.",
          "format": "date-time"
        },
        "notes": {
          "type": "string",
          "description": "Notes taken during the consultation."
        },
        "summary": {
          "type": "string",
          "description": "AI-generated summary of the consultation."
        },
        "noShow": {
          "type": "boolean",
          "description": "Indicates whether the patient was a no-show for the consultation."
        }
      },
      "required": [
        "id",
        "doctorId",
        "startTime"
      ]
    },
    "Clinic": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Clinic",
      "type": "object",
      "description": "Represents a single clinic location.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Clinic entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the clinic."
        },
        "location": {
          "type": "string"
        },
        "logoUrl": {
          "type": "string",
          "format": "uri"
        },
        "phone": {
          "type": "string"
        },
        "email": {
          "type": "string",
          "format": "email"
        },
        "address": {
          "type": "string"
        },
        "city": {
          "type": "string"
        },
        "state": {
          "type": "string"
        },
        "pincode": {
          "type": "string"
        },
        "specialties": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Group": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Group",
      "type": "object",
      "description": "Represents a department or a group of doctors within a clinic.",
      "properties": {
        "id": { "type": "string" },
        "clinicId": { "type": "string" },
        "name": { "type": "string" },
        "tokenInitial": { "type": "string" },
        "location": { "type": "string" },
        "specialties": { "type": "array", "items": { "type": "string" } },
        "contact": { "type": "string", "format": "email" },
        "doctors": { "type": "array", "items": { "type": "object", "properties": { "id": { "type": "string" }, "name": { "type": "string" } } } },
        "assistants": { "type": "array", "items": { "type": "object", "properties": { "id": { "type": "string" }, "name": { "type": "string" } } } },
        "cabins": { "type": "array", "items": { "type": "object", "properties": { "id": { "type": "string" }, "name": { "type": "string" } } } },
        "screens": { "type": "array", "items": { "type": "object", "properties": { "id": { "type": "string" }, "name": { "type": "string" } } } }
      },
      "required": [ "clinicId", "name", "tokenInitial", "doctors" ]
    },
    "Cabin": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Cabin",
      "description": "Represents a consultation room within a clinic.",
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Cabin."
        },
        "name": {
          "type": "string",
          "description": "The name of the cabin, e.g., 'Consultation Room 1'."
        },
        "clinicId": {
          "type": "string",
          "description": "The ID of the clinic this cabin belongs to."
        },
        "assignedDoctorId": {
            "type": "string",
            "description": "The ID of the doctor currently assigned to this cabin."
        },
        "assignedDoctorName": {
            "type": "string",
            "description": "The name of the doctor currently assigned to this cabin."
        },
        "patientInCabinId": {
            "type": "string",
            "description": "The ID of the patient transaction currently in the cabin."
        }
      },
      "required": [
        "id",
        "name",
        "clinicId"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the system (e.g., Doctor, Assistant, Admin, Advertiser).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User document."
        },
        "uid": {
          "type": "string",
          "description": "The user's unique ID from Firebase Authentication."
        },
        "firstName": {
          "type": "string",
          "description": "User's first name."
        },
        "lastName": {
          "type": "string",
          "description": "User's last name."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "roleId": {
          "type": "string",
          "description": "Reference to Role. (Relationship: Role 1:N User)"
        }
      },
      "required": [
        "id",
        "uid",
        "firstName",
        "lastName",
        "email",
        "roleId"
      ]
    },
    "Screen": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Screen",
      "type": "object",
      "description": "Represents a display screen in the clinic.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Screen entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the screen."
        },
        "groupId": {
          "type": "string",
          "description": "Reference to Group. (Relationship: Group 1:N Screen)"
        }
      },
      "required": [
        "id",
        "name",
        "groupId"
      ]
    },
    "Advertisement": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Advertisement",
      "type": "object",
      "description": "Represents an advertisement video.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Advertisement entity."
        },
        "advertiserId": {
          "type": "string",
          "description": "Reference to User (Advertiser). (Relationship: User 1:N Advertisement)"
        },
        "title": {
          "type": "string",
          "description": "Title of the advertisement."
        },
        "videoUrl": {
          "type": "string",
          "description": "URL of the advertisement video.",
          "format": "uri"
        },
        "startDate": {
          "type": "string",
          "description": "Date when the advertisement starts running.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "Date when the advertisement stops running.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "advertiserId",
        "title",
        "videoUrl",
        "startDate",
        "endDate"
      ]
    },
    "Campaign": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Campaign",
      "type": "object",
      "description": "Represents an advertising campaign.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Campaign entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the campaign."
        },
        "advertisementIds": {
          "type": "array",
          "description": "References to Advertisements. (Relationship: Campaign N:N Advertisement)",
          "items": {
            "type": "string"
          }
        },
        "groupIds": {
          "type": "array",
          "description": "References to Groups. (Relationship: Campaign N:N Group)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "advertisementIds",
        "groupIds"
      ]
    },
    "Impression": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Impression",
      "type": "object",
      "description": "Represents an impression count for an advertisement.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Impression entity."
        },
        "advertisementId": {
          "type": "string",
          "description": "Reference to Advertisement. (Relationship: Advertisement 1:N Impression)"
        },
        "screenId": {
          "type": "string",
          "description": "Reference to Screen. (Relationship: Screen 1:N Impression)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of the impression.",
          "format": "date-time"
        },
        "patientCount": {
          "type": "number",
          "description": "Number of patients present when the advertisement was displayed."
        }
      },
      "required": [
        "id",
        "advertisementId",
        "screenId",
        "timestamp",
        "patientCount"
      ]
    },
    "Invoice": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Invoice",
      "type": "object",
      "description": "Represents a billing invoice for a patient consultation.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Invoice entity."
        },
        "patientId": {
          "type": "string",
          "description": "Reference to Patient. (Relationship: Patient 1:N Invoice)"
        },
        "consultationId": {
          "type": "string",
          "description": "Reference to Consultation. (Relationship: Consultation 1:1 Invoice)"
        },
        "amount": {
          "type": "number",
          "description": "The total amount of the invoice."
        },
        "status": {
          "type": "string",
          "description": "The payment status of the invoice.",
          "enum": [
            "unpaid",
            "paid",
            "overdue",
            "cancelled"
          ]
        },
        "issueDate": {
          "type": "string",
          "description": "Date when the invoice was issued.",
          "format": "date-time"
        },
        "dueDate": {
          "type": "string",
          "description": "Date when the payment is due.",
          "format": "date-time"
        },
        "items": {
          "type": "array",
          "description": "Line items for the invoice.",
          "items": {
            "type": "object",
            "properties": {
              "description": {
                "type": "string"
              },
              "amount": {
                "type": "number"
              }
            },
            "required": [
              "description",
              "amount"
            ]
          }
        }
      },
      "required": [
        "id",
        "patientId",
        "consultationId",
        "amount",
        "status",
        "issueDate",
        "dueDate"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Represents a user role in the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Role entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the role (e.g., Doctor, Assistant, Admin)."
        }
      },
      "required": [
        "id",
        "name"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. User ID is used for authentication and authorization.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "RoleAdmin",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection to store admin users. Document ID is the user ID. Existence implies admin role.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the admin user, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/clinics/{clinicId}",
        "definition": {
          "entityName": "Clinic",
          "schema": {
            "$ref": "#/backend/entities/Clinic"
          },
          "description": "Stores clinic information.",
          "params": [
            {
              "name": "clinicId",
              "description": "The unique ID of the clinic."
            }
          ]
        }
      },
      {
        "path": "/groups/{groupId}",
        "definition": {
          "entityName": "Group",
          "schema": {
            "$ref": "#/backend/entities/Group"
          },
          "description": "Stores groups (departments) of a clinic.",
          "params": [
            {
              "name": "groupId",
              "description": "The unique ID of the group."
            }
          ]
        }
      },
      {
        "path": "/patient_master/{patientMasterId}",
        "definition": {
          "entityName": "PatientMaster",
          "schema": { "$ref": "#/backend/entities/PatientMaster" },
          "description": "Stores patient master demographic data. Document ID is the patient master ID.",
          "params": [{ "name": "patientMasterId", "description": "The unique ID of the patient master record." }]
        }
      },
      {
        "path": "/patient_transactions/{patientTransactionId}",
        "definition": {
          "entityName": "PatientTransaction",
          "schema": { "$ref": "#/backend/entities/PatientTransaction" },
          "description": "Stores individual patient visit/transaction records. Document ID is the transaction ID.",
          "params": [{ "name": "patientTransactionId", "description": "The unique ID of the patient transaction." }]
        }
      },
       {
        "path": "/cabins/{cabinId}",
        "definition": {
          "entityName": "Cabin",
          "schema": {
            "$ref": "#/backend/entities/Cabin"
          },
          "description": "Stores cabins as a top-level collection, queryable by clinicId.",
          "params": [
            {
              "name": "cabinId",
              "description": "The unique ID of the cabin."
            }
          ]
        }
      },
      {
        "path": "/consultations/{consultationId}",
        "definition": {
          "entityName": "Consultation",
          "schema": {
            "$ref": "#/backend/entities/Consultation"
          },
          "description": "Stores consultation data between a doctor and a patient.",
          "params": [
            {
              "name": "consultationId",
              "description": "The unique ID of the consultation."
            }
          ]
        }
      },
      {
        "path": "/screens/{screenId}",
        "definition": {
          "entityName": "Screen",
          "schema": {
            "$ref": "#/backend/entities/Screen"
          },
          "description": "Stores screen details.",
          "params": [
            {
              "name": "screenId",
              "description": "The unique ID of the screen."
            }
          ]
        }
      },
      {
        "path": "/advertisements/{advertisementId}",
        "definition": {
          "entityName": "Advertisement",
          "schema": {
            "$ref": "#/backend/entities/Advertisement"
          },
          "description": "Stores advertisement videos uploaded by advertisers.",
          "params": [
            {
              "name": "advertisementId",
              "description": "The unique ID of the advertisement."
            }
          ]
        }
      },
      {
        "path": "/campaigns/{campaignId}",
        "definition": {
          "entityName": "Campaign",
          "schema": {
            "$ref": "#/backend/entities/Campaign"
          },
          "description": "Stores advertising campaigns.",
          "params": [
            {
              "name": "campaignId",
              "description": "The unique ID of the campaign."
            }
          ]
        }
      },
      {
        "path": "/impressions/{impressionId}",
        "definition": {
          "entityName": "Impression",
          "schema": {
            "$ref": "#/backend/entities/Impression"
          },
          "description": "Stores impression counts for advertisements.",
          "params": [
            {
              "name": "impressionId",
              "description": "The unique ID of the impression."
            }
          ]
        }
      },
      {
        "path": "/invoices/{invoiceId}",
        "definition": {
          "entityName": "Invoice",
          "schema": {
            "$ref": "#/backend/entities/Invoice"
          },
          "description": "Stores billing invoices for patient consultations.",
          "params": [
            {
              "name": "invoiceId",
              "description": "The unique ID of the invoice."
            }
          ]
        }
      },
      {
        "path": "/roles/{roleId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Stores user roles.",
          "params": [
            {
              "name": "roleId",
              "description": "The unique ID of the role."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure security, scalability, and ease of debugging, following the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). Authorization Independence is achieved through denormalization, where necessary authorization data is duplicated within documents to avoid relying on `get()` calls in security rules. Structural Segregation ensures that each collection has a homogeneous security posture.\n\nThe structure uses path-based ownership for user-related data (e.g., `/users/{userId}/...`) and membership maps for collaborative data. Global roles are managed through dedicated collections (e.g., `/roles_admin/{uid}`).  The design incorporates explicit state modeling using a `status` field and enforces radical consistency with semantic naming conventions.\n\nTo support the core features, the following approach is considered:\n\n*   **QR Code Patient Registration & Token Generation:** Patients are registered under a specific `Clinic` after scanning a QR code. A `Token` is generated and linked to the patient and group. The group ID is denormalized into the `Token` document to allow filtering by screens.\n*   **Queue Display & Doctor Call Notification:** The queue display uses a combination of patients and group information. The `groupId` on the `Patient` and `Token` records are used to filter displayed tokens per each `Screen`.\n*   **Consultation Management:** Consultations are linked to doctors and patients. AI summaries are stored in the consultation document.\n*   **Assistant Token Creation:** Assistants can create tokens under a specific group on behalf of patients.\n*   **Clinic Group Management:** Groups are created to represent screens, cabins, doctors, and assistants.  These groups and its id are crucial for queue management and display.\n*   **Advertising Management:** Advertisements are managed through an admin portal and associated with campaigns and groups. Impressions are tracked to measure advertisement performance.\n\nThis design supports the required QAPs by using structural segregation and membership models, ensuring that list operations can be securely performed based on user roles and group memberships."
  }
}

    